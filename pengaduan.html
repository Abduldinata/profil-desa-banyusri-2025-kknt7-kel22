<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desa Banyusri - Pengaduan Online</title>
    <link rel="stylesheet" href="css/pengaduan.css">
</head>
<body>
        <!-- Loading di luar alert -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Memproses pengaduan Anda...</p>
        </div>

        <!-- Alert container -->
        <div id="alert-container"></div>
        
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">
                    <img src="img/logo.png" style="height:48px;width:auto;">
                </div>
                <div class="header-text">
                    <h1>DESA BANYUSRI</h1>
                    <p>Kecamatan Wonosegoro, Kabupaten Boyolali</p>
                </div>
            </div>
<!-- Tambahkan di dalam header-content yang sudah ada -->
<div class="admin-access">
    <a href="login.html" class="admin-link" title="Login Admin">
        <span class="admin-icon">👤</span>
        <span class="admin-text">Admin</span>
    </a>
</div>
        </div>
    </header>

    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <a href="index.html" class="nav-item">🏠 Beranda</a>
            <a href="profil.html" class="nav-item">📋 Profil Desa</a>
            <a href="#" class="nav-item active">📢 Pengaduan</a>
            <a href="kontak.html" class="nav-item">📞 Kontak</a>
        </div>
    </nav>

    <!-- Pengaduan Page Content -->
    <div class="page-content active">
        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-content">
                <h2>📢 Layanan Pengaduan Online</h2>
                <p>Sampaikan keluhan, saran, dan aspirasi Anda untuk kemajuan Desa Banyusri</p>
                <div class="hero-buttons">
                    <a href="#form-pengaduan" class="btn btn-primary">📝 Buat Pengaduan</a>
                    <a href="#info-layanan" class="btn btn-secondary">ℹ️ Info Layanan</a>
                </div>
            </div>
        </section>

        <div class="content">
            <!-- Informasi Layanan -->
            <section class="section" id="info-layanan">
                <h2>Informasi Layanan Pengaduan</h2>
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-icon">📝</div>
                        <h3>Mudah Digunakan</h3>
                        <p>Form pengaduan yang sederhana dan mudah dipahami oleh semua kalangan masyarakat.</p>
                    </div>
                    <div class="card">
                        <div class="card-icon">⏰</div>
                        <h3>Respons Cepat</h3>
                        <p>Pengaduan akan ditanggapi dalam waktu maksimal 1x24 jam kerja.</p>
                    </div>
                    <div class="card">
                        <div class="card-icon">🔒</div>
                        <h3>Terjamin Privasi</h3>
                        <p>Data pribadi Anda akan dijaga kerahasiaannya sesuai ketentuan yang berlaku.</p>
                    </div>
                    <div class="card">
                        <div class="card-icon">📧</div>
                        <h3>Langsung ke Email</h3>
                        <p>Pengaduan langsung dikirim ke email resmi balai desa untuk penanganan cepat.</p>
                    </div>
                </div>
            </section>

            
            <!-- Jenis Pengaduan -->
            <section class="section" id="jenis-pengaduan">
                <h2>Jenis Pengaduan</h2>
                <div class="complaint-types">
                    <div class="type-item">🏗️ Infrastruktur Desa</div>
                    <div class="type-item">🏛️ Pelayanan Publik</div>
                    <div class="type-item">🌱 Lingkungan Hidup</div>
                    <div class="type-item">🛡️ Keamanan & Ketertiban</div>
                    <div class="type-item">📄 Administrasi Kependudukan</div>
                    <div class="type-item">📋 Lainnya</div>
                </div>
            </section>

            <!-- Alur Pengaduan -->
            <section class="section" id="alur-pengaduan">
                <h2>Alur Pengaduan</h2>
                <div class="process-steps">
                    <div class="step-item">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Isi Form Pengaduan</h3>
                            <p>Lengkapi form pengaduan dengan data yang akurat dan jelas</p>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>Kirim Pengaduan</h3>
                            <p>Pengaduan akan dikirim langsung ke email resmi balai desa</p>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>Verifikasi Data</h3>
                            <p>Petugas akan memverifikasi dan menindaklanjuti pengaduan Anda</p>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h3>Tindak Lanjut</h3>
                            <p>Anda akan dihubungi untuk update perkembangan pengaduan</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Form Pengaduan -->
            <section class="section" id="form-pengaduan">
            <h2>Form Pengaduan Online</h2>

        <form id="complaint-form" class="complaint-form">
            <!-- Nama, NIK, Telepon tetap seperti biasa -->
            <div class="form-group">
            <label for="nama">Nama Lengkap *</label>
            <input type="text" id="nama" name="nama" required placeholder="Masukkan nama lengkap Anda">
            </div>

            <div class="form-group">
            <label for="nik">NIK *</label>
            <input type="text" id="nik" name="nik" required maxlength="16" placeholder="Masukkan NIK Anda">
            </div>

            <div class="form-group">
            <label for="telepon">No. Telepon *</label>
            <input type="tel" id="telepon" name="telepon" required placeholder="Masukkan nomor telepon Anda">
            </div>

        <!-- Tambahan Email + OTP -->
        <div class="form-group">
        <label for="email">Email *</label>
        <input type="email" id="email" name="email" required placeholder="email@contoh.com">
        <button type="button" id="btn-kirim-otp" class="btn btn-secondary" style="margin-top: 10px">🔐 Kirim Kode Verifikasi</button>
        <div id="otp-section" style="display:none; margin-top: 10px;">
            <label for="otp">Masukkan Kode OTP *</label>
            <input type="text" id="otp" name="otp" placeholder="6 digit kode" maxlength="6" required>
            <button type="button" id="btn-verifikasi-otp" class="btn btn-primary" style="margin-top: 10px">✅ Verifikasi OTP</button>
        </div>
        </div>

        <!-- Alamat, Jenis Pengaduan, dll -->
        <div class="form-group">
        <label for="alamat">Alamat *</label>
        <input type="text" id="alamat" name="alamat" required placeholder="Masukkan alamat lengkap Anda">
        </div>

        <div class="form-group">
            <label for="jenis_pengaduan">Jenis Pengaduan *</label>
            <select id="jenis_pengaduan" name="jenis_pengaduan" required>
            <option value="">-- Pilih Jenis Pengaduan --</option>
            <option value="infrastruktur">🏗️ Infrastruktur Desa</option>
            <option value="pelayanan_publik">🏛️ Pelayanan Publik</option>
            <option value="keamanan">🛡️ Keamanan & Ketertiban</option>
            <option value="lingkungan">🌱 Lingkungan Hidup</option>
            <option value="administrasi">📄 Administrasi Kependudukan</option>
            <option value="sosial">🤝 Bantuan Sosial & Kesejahteraan</option>
            <option value="ekonomi">💼 Ekonomi & UMKM</option>
            <option value="pendidikan">🎓 Pendidikan & Sekolah</option>
            <option value="kesehatan">🏥 Kesehatan & Posyandu</option>
            <option value="agama">🕌 Kegiatan Keagamaan</option>
            <option value="kebudayaan">🎭 Kebudayaan & Kesenian</option>
            <option value="lainnya">📋 Lainnya</option>
            </select>
        </div>

        <div class="form-group">
        <label for="judul_pengaduan">Judul *</label>
        <input type="text" id="judul_pengaduan" name="judul_pengaduan" required placeholder="Masukkan judul pengaduan Anda">
        </div>

        <div class="form-group">
        <label for="isi_pengaduan">Isi Pengaduan *</label>
        <textarea id="isi_pengaduan" name="isi_pengaduan" required placeholder="Jelaskan pengaduan Anda secara rinci"></textarea>
        </div>

        <div class="form-group">
        <label for="harapan">Harapan/Saran</label>
        <textarea id="harapan" name="harapan" placeholder="Tuliskan harapan atau saran Anda"></textarea>
        </div>

        <div class="button-group">
        <button type="submit" class="btn btn-primary">📤 Kirim Pengaduan</button>
        <button type="reset" class="btn btn-secondary">🔄 Reset</button>
        </div>
        </form>
        </section>

            <!-- Kontak Langsung -->
            <section class="section " id="kontak-langsung">
                <h2>Kontak Langsung</h2>
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-icon">📞</div>
                        <h3>Telepon Balai Desa</h3>
                        <p><strong>(0276) 123456</strong></p>
                        <p>Senin - Jumat: 08:00 - 15:00 WIB</p>
                    </div>
                    <div class="card">
                        <div class="card-icon">📱</div>
                        <h3>WhatsApp</h3>
                        <p><strong>0812-3456-7890</strong></p>
                        <p>Untuk pengaduan darurat 24 jam</p>
                    </div>
                    <div class="card">
                        <div class="card-icon">📧</div>
                        <h3>Email Resmi</h3>
                        <p><strong>pengaduan@banyusri.desa.id</strong></p>
                        <p>Respon maksimal 1x24 jam</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-links">
                <a href="index.html">Beranda</a>
                <a href="profil.html">Profil Desa</a>
                <a href="pengaduan.html">Pengaduan</a>
                <a href="kontak.html">Kontak</a>
            </div>
            <p>&copy; 2025 Desa Banyusri | KKN Tematik Periode 7 Kelompok 22 Universitas Duta Bangsa</p>
            <p>Website Resmi Pemerintah Desa Banyusri</p>
        </div>
    </footer>

    <script>
           let otpTerverifikasi = false;
        let otpDikirim = false;

        // Utility function untuk menampilkan loading
            function showLoading(text = 'Memproses...') {
            const loadingElement = document.getElementById('loading');
            const loadingText = loadingElement.querySelector('p');  // ✅ BENAR
            
            if (loadingText) {
                loadingText.textContent = text;
            }
            loadingElement.style.display = 'flex';
        }

        // Utility function untuk menyembunyikan loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Utility function untuk menampilkan alert
        function showAlert(message, type = 'info') {
            console.log('>> showAlert dipanggil:', message, type);
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            
            // Clear previous alerts
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            // Show alert with animation
            setTimeout(() => {
                alert.classList.add('show');
            }, 100);
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, 5000);
        }

        // Disable/Enable button
        function toggleButtonState(buttonId, disabled, text = null) {
            const button = document.getElementById(buttonId);
            button.disabled = disabled;
            if (text) {
                button.innerHTML = text;
            }
        }

        // Event listener untuk kirim OTP
        document.getElementById('btn-kirim-otp').addEventListener('click', async function() {
            console.log('Tombol kirim OTP diklik'); // ✅ Tambahkan ini
            
            const email = document.getElementById('email').value.trim();
            
            if (!email) {
                console.log('Email kosong'); // ✅ Tambahkan ini
                showAlert('❌ Mohon masukkan email terlebih dahulu', 'error');
                return;
            }

            // Validasi format email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showAlert('❌ Format email tidak valid', 'error');
                return;
            }

            // Show loading
            showLoading('Mengirim kode OTP...');
            toggleButtonState('btn-kirim-otp', true, '⏳ Mengirim...');

            try {
                const response = await fetch('https://profil-desa-banyusri-2025-kknt7-kel22-production.up.railway.app/kirim-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('✅ ' + data.message, 'success');
                    document.getElementById('otp-section').style.display = 'block';
                    otpDikirim = true;
                    toggleButtonState('btn-kirim-otp', false, '🔄 Kirim Ulang OTP');
                } else {
                    showAlert('❌ ' + data.message, 'error');
                    toggleButtonState('btn-kirim-otp', false, '🔐 Kirim Kode Verifikasi');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('❌ Gagal menghubungi server. Silakan coba lagi.', 'error');
                toggleButtonState('btn-kirim-otp', false, '🔐 Kirim Kode Verifikasi');
            } finally {
                hideLoading();
            }
        });

        // Event listener untuk verifikasi OTP
        document.getElementById('btn-verifikasi-otp').addEventListener('click', async function() {
            const email = document.getElementById('email').value.trim();
            const otp = document.getElementById('otp').value.trim();

            if (!email || !otp) {
                showAlert('❌ Mohon masukkan email dan kode OTP', 'error');
                return;
            }

            if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
                showAlert('❌ Kode OTP harus 6 digit angka', 'error');
                return;
            }

            // Show loading
            showLoading('Memverifikasi OTP...');
            toggleButtonState('btn-verifikasi-otp', true, '⏳ Memverifikasi...');

            try {
                const response = await fetch('https://profil-desa-banyusri-2025-kknt7-kel22-production.up.railway.app/verifikasi-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, otp })
                });

                const data = await response.json();
                
                if (data.success) {
                    otpTerverifikasi = true;
                    showAlert('✅ Verifikasi berhasil! Anda dapat mengirim pengaduan.', 'success');
                    
                    // Update UI
                    document.getElementById('otp-section').style.backgroundColor = '#d4edda';
                    document.getElementById('otp-section').style.borderColor = '#28a745';
                    toggleButtonState('btn-verifikasi-otp', true, '✅ Terverifikasi');
                    
                    // Disable email field
                    document.getElementById('email').disabled = true;
                    document.getElementById('otp').disabled = true;
                } else {
                    showAlert('❌ ' + data.message, 'error');
                    toggleButtonState('btn-verifikasi-otp', false, '✅ Verifikasi OTP');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('❌ Gagal memverifikasi OTP. Silakan coba lagi.', 'error');
                toggleButtonState('btn-verifikasi-otp', false, '✅ Verifikasi OTP');
            } finally {
                hideLoading();
            }
        });

        // Event listener untuk submit form
        document.getElementById('complaint-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validasi OTP
            if (!otpTerverifikasi) {
                showAlert('❌ Silakan verifikasi email terlebih dahulu', 'error');
                document.getElementById('email').focus();
                return;
            }

            // Validasi form
            const requiredFields = ['nama', 'nik', 'telepon', 'email', 'alamat', 'jenis_pengaduan', 'judul_pengaduan', 'isi_pengaduan'];
            for (let field of requiredFields) {
                const value = document.getElementById(field).value.trim();
                if (!value) {
                    showAlert(`❌ Field ${field.replace('_', ' ')} harus diisi`, 'error');
                    document.getElementById(field).focus();
                    return;
                }
            }

            // Validasi NIK
            const nik = document.getElementById('nik').value.trim();
            if (!/^\d{16}$/.test(nik)) {
                showAlert('❌ NIK harus 16 digit angka', 'error');
                document.getElementById('nik').focus();
                return;
            }

            // Collect form data
            const formData = new FormData(this);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value.trim();
            }

            // Show loading
            showLoading('Mengirim pengaduan...');
            
            // Disable submit button
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '⏳ Mengirim...';

            try {
                const response = await fetch('https://profil-desa-banyusri-2025-kknt7-kel22-production.up.railway.app/kirim-pengaduan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (result.success) {
                    showAlert('🎉 Pengaduan berhasil dikirim! Terima kasih atas partisipasi Anda.', 'success');
                    
                    // Reset form
                    this.reset();
                    otpTerverifikasi = false;
                    otpDikirim = false;
                    document.getElementById('otp-section').style.display = 'none';
                    document.getElementById('email').disabled = false;
                    document.getElementById('btn-kirim-otp').innerHTML = '🔐 Kirim Kode Verifikasi';
                    
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    showAlert('❌ ' + (result.message || 'Gagal mengirim pengaduan'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('❌ Gagal mengirim pengaduan. Silakan periksa koneksi internet dan coba lagi.', 'error');
            } finally {
                hideLoading();
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Format NIK input (hanya angka)
        document.getElementById('nik').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            
            // Visual feedback
            if (this.value.length === 16) {
                this.style.borderColor = '#28a745';
            } else if (this.value.length > 0) {
                this.style.borderColor = '#ffc107';
            } else {
                this.style.borderColor = '#dc3545';
            }
        });

        // Format OTP input (hanya angka)
        document.getElementById('otp').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
            
            // Visual feedback
            if (this.value.length === 6) {
                this.style.borderColor = '#28a745';
            } else if (this.value.length > 0) {
                this.style.borderColor = '#ffc107';
            } else {
                this.style.borderColor = '#dc3545';
            }
        });

        // Email validation
        document.getElementById('email').addEventListener('input', function(e) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(this.value)) {
                this.style.borderColor = '#28a745';
            } else if (this.value.length > 0) {
                this.style.borderColor = '#ffc107';
            } else {
                this.style.borderColor = '#dc3545';
            }
        });

        // Prevent form submission on Enter key in OTP field
        document.getElementById('otp').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('btn-verifikasi-otp').click();
            }
        });

        // Auto-focus OTP field when section is shown
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    const otpSection = document.getElementById('otp-section');
                    if (otpSection.style.display === 'block') {
                        setTimeout(() => {
                            document.getElementById('otp').focus();
                        }, 100);
                    }
                }
            });
        });

        observer.observe(document.getElementById('otp-section'), {
            attributes: true,
            attributeFilter: ['style']
        });

        // Show info alert on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                showAlert('ℹ️ Silakan isi form dengan data yang valid. Email akan diverifikasi terlebih dahulu.', 'info');
            }, 1000);
        });
    </script>
</body>
</html>